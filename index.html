<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Savings Tracker v3.0.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap');
        
        :root {
            --primary: #2563eb;
            --accent: #f59e0b;
        }

        body {
            font-family: 'Kanit', sans-serif;
            background-color: #f1f5f9;
            padding-bottom: 100px;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 4px 20px -5px rgba(0, 0, 0, 0.05);
        }

        .nav-item { color: #94a3b8; transition: 0.3s; }
        .nav-item.active { color: var(--primary); transform: translateY(-3px); }

        #pin-overlay {
            position: fixed;
            inset: 0;
            background: #ffffff;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .pin-dot {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            border: 2px solid #e2e8f0;
            transition: 0.2s;
        }

        .pin-dot.filled {
            background: var(--primary);
            border-color: var(--primary);
            transform: scale(1.2);
        }

        .keypad-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: #f8fafc;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 600;
            color: #1e293b;
        }

        .keypad-btn:active:not(:disabled) { background: #e2e8f0; transform: scale(0.9); }
        .keypad-btn:disabled { opacity: 0.2; cursor: not-allowed; }
        
        .hidden-section { display: none; }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-10px); }
            40%, 80% { transform: translateX(10px); }
        }
        .shake { animation: shake 0.4s; }

        .btn-gradient {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.3);
        }
    </style>
</head>
<body>

    <!-- PIN Guard Layer -->
    <div id="pin-overlay">
        <div class="text-center mb-10">
            <div id="pin-icon-box" class="w-20 h-20 bg-blue-50 text-blue-600 rounded-[2rem] flex items-center justify-center mx-auto mb-5 text-3xl shadow-inner">
                <i id="pin-icon" class="fa-solid fa-fingerprint"></i>
            </div>
            <h2 id="pin-label" class="text-2xl font-black text-slate-800 tracking-tight">ยืนยันตัวตน v3.0</h2>
            <p id="pin-sub-label" class="text-slate-400 text-sm mt-1">กรุณากรอกรหัส PIN 4 หลัก</p>
        </div>

        <div id="dots-container" class="flex space-x-6 mb-12">
            <div class="pin-dot" id="dot-0"></div>
            <div class="pin-dot" id="dot-1"></div>
            <div class="pin-dot" id="dot-2"></div>
            <div class="pin-dot" id="dot-3"></div>
        </div>

        <div class="grid grid-cols-3 gap-6" id="keypad">
            <button class="keypad-btn" onclick="tapKey('1')">1</button>
            <button class="keypad-btn" onclick="tapKey('2')">2</button>
            <button class="keypad-btn" onclick="tapKey('3')">3</button>
            <button class="keypad-btn" onclick="tapKey('4')">4</button>
            <button class="keypad-btn" onclick="tapKey('5')">5</button>
            <button class="keypad-btn" onclick="tapKey('6')">6</button>
            <button class="keypad-btn" onclick="tapKey('7')">7</button>
            <button class="keypad-btn" onclick="tapKey('8')">8</button>
            <button class="keypad-btn" onclick="tapKey('9')">9</button>
            <div></div>
            <button class="keypad-btn" onclick="tapKey('0')">0</button>
            <button class="keypad-btn text-slate-300" onclick="tapKey('del')"><i class="fa-solid fa-delete-left"></i></button>
        </div>
    </div>

    <!-- Main Application UI -->
    <div id="main-ui" style="display:none; opacity:0; transition: 0.5s;">
        <div class="max-w-md mx-auto p-6">
            
            <header class="flex justify-between items-start mb-8">
                <div>
                    <span id="date-display" class="text-[10px] font-bold text-blue-500 uppercase tracking-[0.2em]">...</span>
                    <h1 class="text-3xl font-black text-slate-900 mt-1">Wallet <span class="text-blue-600">3.0</span></h1>
                </div>
                <div class="flex flex-col items-end">
                    <div class="bg-gradient-to-br from-orange-400 to-red-500 p-2 px-4 rounded-2xl text-white flex items-center space-x-2 shadow-lg shadow-orange-100">
                        <i class="fa-solid fa-fire text-sm"></i>
                        <span id="streak-val" class="text-lg font-black">0</span>
                    </div>
                </div>
            </header>

            <!-- Home Section -->
            <main id="home-section" class="space-y-6">
                <!-- Balance Card -->
                <div class="glass-card p-8 bg-slate-900 text-white relative overflow-hidden shadow-2xl shadow-blue-100">
                    <div class="absolute -right-4 -top-4 w-24 h-24 bg-blue-500/10 rounded-full blur-2xl"></div>
                    <p class="text-slate-400 text-[10px] font-bold uppercase tracking-widest mb-1">ยอดเงินคงเหลือปัจจุบัน</p>
                    <div class="flex items-baseline space-x-2">
                        <span class="text-blue-400 text-2xl font-bold">฿</span>
                        <h2 id="balance-val" class="text-5xl font-black tracking-tighter">0.00</h2>
                    </div>
                </div>

                <!-- Goal Card -->
                <div class="glass-card p-6">
                    <div class="flex justify-between items-end mb-3">
                        <div>
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">ความคืบหน้าเป้าหมาย</p>
                            <h3 id="goal-percent-val" class="text-2xl font-black text-slate-800">0%</h3>
                        </div>
                        <p id="goal-label" class="text-xs font-bold text-blue-600">0 / 5,000 ฿</p>
                    </div>
                    <div class="w-full h-3 bg-slate-100 rounded-full overflow-hidden">
                        <div id="progress-bar" class="h-full bg-blue-600 w-0 transition-all duration-1000 ease-out"></div>
                    </div>
                </div>

                <!-- Input Card -->
                <div class="glass-card p-6">
                    <div class="relative mb-4">
                        <input type="number" id="main-input" placeholder="0.00" class="w-full p-5 bg-slate-50 rounded-3xl text-3xl font-black text-slate-800 outline-none border-2 border-transparent focus:border-blue-100 transition-all" inputmode="decimal">
                        <span class="absolute right-5 top-1/2 -translate-y-1/2 text-slate-300 font-bold">THB</span>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="record('save')" class="btn-gradient py-5 text-white rounded-3xl font-bold active:scale-95 transition-all flex items-center justify-center space-x-2">
                            <i class="fa-solid fa-plus-circle"></i> <span>เงินออม</span>
                        </button>
                        <button onclick="record('spend')" class="bg-white border-2 border-slate-100 py-5 text-slate-600 rounded-3xl font-bold active:scale-95 transition-all flex items-center justify-center space-x-2">
                            <i class="fa-solid fa-minus-circle text-red-400"></i> <span>รายจ่าย</span>
                        </button>
                    </div>
                </div>

                <!-- History -->
                <div class="glass-card p-6">
                    <h4 class="font-bold text-slate-800 mb-5 flex items-center space-x-2">
                        <i class="fa-solid fa-clock-rotate-left text-blue-500"></i>
                        <span>รายการล่าสุด</span>
                    </h4>
                    <div id="history-box" class="space-y-4 max-h-[300px] overflow-y-auto pr-1">
                        <!-- List Items -->
                    </div>
                </div>
            </main>

            <!-- Stats Section -->
            <section id="stats-section" class="hidden-section space-y-6">
                <div class="glass-card p-6">
                    <h3 class="font-bold text-slate-800 mb-6 flex items-center space-x-2">
                        <i class="fa-solid fa-chart-line text-blue-500"></i>
                        <span>สถิติการออม 7 วัน</span>
                    </h3>
                    <div class="h-[250px]"><canvas id="mainChart"></canvas></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="glass-card p-5 text-center">
                        <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">ออมสูงสุดต่อวัน</p>
                        <p id="max-save-val" class="text-xl font-black text-slate-800">0 ฿</p>
                    </div>
                    <div class="glass-card p-5 text-center">
                        <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">เฉลี่ยต่อวัน</p>
                        <p id="avg-save-val" class="text-xl font-black text-slate-800">0 ฿</p>
                    </div>
                </div>
            </section>

            <!-- Settings Section -->
            <section id="settings-section" class="hidden-section space-y-6">
                <div class="glass-card p-6">
                    <h3 class="font-bold text-slate-800 mb-4">เป้าหมายรายเดือน</h3>
                    <div class="flex space-x-3">
                        <input type="number" id="goal-input" class="flex-1 p-4 bg-slate-50 rounded-2xl font-bold outline-none border border-slate-100">
                        <button onclick="updateGoal()" class="px-6 bg-slate-900 text-white rounded-2xl font-bold active:scale-95 transition-all">ตั้งค่า</button>
                    </div>
                </div>
                <div class="glass-card p-6 border-l-4 border-blue-500">
                    <h3 class="font-bold text-slate-800 mb-2">ข้อมูลแอพ</h3>
                    <p class="text-xs text-slate-500 leading-relaxed">เวอร์ชั่น 3.0.0 (Ultimate Edition)<br>ข้อมูลของคุณถูกเก็บไว้ในพื้นที่จัดเก็บที่ปลอดภัยที่สุดของเบราว์เซอร์</p>
                </div>
                <button onclick="wipe()" class="w-full py-4 text-red-400 font-bold text-sm opacity-50 hover:opacity-100 transition-opacity">รีเซ็ตข้อมูลและรหัสผ่านทั้งหมด</button>
            </section>

            <!-- Bottom Nav -->
            <nav class="fixed bottom-0 left-0 right-0 h-24 bg-white/80 backdrop-blur-xl border-t border-slate-100 flex justify-around items-center px-10 z-[1000]">
                <button onclick="tab('home')" id="btn-home" class="nav-item active flex flex-col items-center">
                    <i class="fa-solid fa-house-user text-xl"></i>
                    <span class="text-[9px] font-black uppercase mt-1">Home</span>
                </button>
                <button onclick="tab('stats')" id="btn-stats" class="nav-item flex flex-col items-center">
                    <i class="fa-solid fa-chart-simple text-xl"></i>
                    <span class="text-[9px] font-black uppercase mt-1">Stats</span>
                </button>
                <button onclick="tab('settings')" id="btn-settings" class="nav-item flex flex-col items-center">
                    <i class="fa-solid fa-sliders text-xl"></i>
                    <span class="text-[9px] font-black uppercase mt-1">Setup</span>
                </button>
            </nav>

        </div>
    </div>

    <script>
        // Version 3.0 Core Logic
        const VERSION = "3.0.0";
        const STORAGE_KEY = "wallet_v3_core_data";
        const PIN_KEY = "wallet_v3_pin_secure";
        const LOCK_UNTIL_KEY = "wallet_v3_lockout";
        const WRONG_KEY = "wallet_v3_wrong_count";

        let appState = {
            v: VERSION,
            balance: 0,
            goal: 5000,
            streak: 0,
            lastEntryDate: null,
            history: [],
            dailyStats: {}
        };

        let inputPin = "";
        let lockTimer = null;

        function initApp() {
            // --- Migration Logic (v1, v2, v2.5 to v3) ---
            const v3Data = localStorage.getItem(STORAGE_KEY);
            const v25Data = localStorage.getItem('my_savings_app_data_secure');
            const v2Data = localStorage.getItem('savings_app_v25');
            
            // Priority: v3 > v2.5 > v2
            const rawData = v3Data || v25Data || v2Data;

            if (rawData) {
                try {
                    const parsed = JSON.parse(rawData);
                    // Merge older structures into v3
                    appState = {
                        ...appState,
                        ...parsed,
                        balance: parsed.balance ?? parsed.totalBalance ?? 0,
                        history: parsed.history ?? parsed.savingsHistory ?? [],
                        dailyStats: parsed.daily ?? parsed.dailyStats ?? {},
                        v: VERSION
                    };
                    save();
                } catch(e) { console.error("Migration failed", e); }
            }

            // Sync PIN from older versions if exists
            const oldPin = localStorage.getItem('my_savings_app_pin') || localStorage.getItem('savings_app_lock_v1');
            if (oldPin && !localStorage.getItem(PIN_KEY)) {
                localStorage.setItem(PIN_KEY, oldPin);
            }

            // Setup View
            const now = new Date();
            document.getElementById('date-display').innerText = new Intl.DateTimeFormat('th-TH', { weekday:'long', day:'numeric', month:'long' }).format(now);
            
            checkLockout();
            updateUI();
        }

        // --- PIN & Lockout ---
        function tapKey(k) {
            if (k === 'del') {
                inputPin = inputPin.slice(0, -1);
            } else if (inputPin.length < 4) {
                inputPin += k;
            }
            syncDots();
            if (inputPin.length === 4) setTimeout(verifyPin, 150);
        }

        function syncDots() {
            for (let i=0; i<4; i++) {
                const dot = document.getElementById(`dot-${i}`);
                dot.classList.toggle('filled', i < inputPin.length);
            }
        }

        function verifyPin() {
            const saved = localStorage.getItem(PIN_KEY);
            if (!saved) {
                localStorage.setItem(PIN_KEY, inputPin);
                unlock();
            } else if (inputPin === saved) {
                localStorage.setItem(WRONG_KEY, "0");
                unlock();
            } else {
                let wrong = parseInt(localStorage.getItem(WRONG_KEY) || "0") + 1;
                localStorage.setItem(WRONG_KEY, wrong.toString());
                
                if (wrong >= 2) {
                    const lockTime = Date.now() + 60000;
                    localStorage.setItem(LOCK_UNTIL_KEY, lockTime.toString());
                    checkLockout();
                } else {
                    shakePin("รหัสผิด! ลองได้อีก 1 ครั้ง");
                }
            }
        }

        function shakePin(msg) {
            inputPin = "";
            syncDots();
            const label = document.getElementById('pin-label');
            label.innerText = msg;
            label.classList.add('text-red-500');
            document.getElementById('dots-container').classList.add('shake');
            setTimeout(() => {
                label.classList.remove('text-red-500');
                document.getElementById('dots-container').classList.remove('shake');
                label.innerText = "ยืนยันตัวตน v3.0";
            }, 1000);
        }

        function checkLockout() {
            const until = parseInt(localStorage.getItem(LOCK_UNTIL_KEY) || "0");
            if (Date.now() < until) {
                inputPin = "";
                syncDots();
                const btns = document.querySelectorAll('.keypad-btn');
                btns.forEach(b => b.disabled = true);
                
                if (lockTimer) clearInterval(lockTimer);
                lockTimer = setInterval(() => {
                    const remain = Math.ceil((until - Date.now()) / 1000);
                    if (remain <= 0) {
                        clearInterval(lockTimer);
                        btns.forEach(b => b.disabled = false);
                        localStorage.setItem(WRONG_KEY, "0");
                        localStorage.removeItem(LOCK_UNTIL_KEY);
                        document.getElementById('pin-label').innerText = "ยืนยันตัวตน v3.0";
                        document.getElementById('pin-sub-label').innerText = "ปลดล็อคแล้ว ลองใหม่ได้ครับ";
                    } else {
                        document.getElementById('pin-label').innerText = "ระบบถูกระงับ";
                        document.getElementById('pin-sub-label').innerText = `รออีก ${remain} วินาที...`;
                    }
                }, 1000);
            }
        }

        function unlock() {
            document.getElementById('pin-overlay').style.display = 'none';
            const ui = document.getElementById('main-ui');
            ui.style.display = 'block';
            setTimeout(() => ui.style.opacity = "1", 50);
        }

        // --- Core Logic ---
        function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(appState)); }

        function record(type) {
            const input = document.getElementById('main-input');
            let val = parseFloat(input.value);
            if (!val || val <= 0) return;

            if (type === 'spend') val = -val;
            appState.balance += val;

            const today = new Date().toISOString().split('T')[0];
            if (val > 0) {
                appState.dailyStats[today] = (appState.dailyStats[today] || 0) + val;
                if (appState.lastEntryDate !== today) {
                    appState.streak++;
                    appState.lastEntryDate = today;
                }
            }

            appState.history.unshift({
                id: Date.now(),
                val: val,
                time: new Date().toLocaleTimeString('th-TH', { hour:'2-digit', minute:'2-digit' }),
                date: new Date().toLocaleDateString('th-TH', { day:'numeric', month:'short' })
            });

            // Keep max 50 history records
            if (appState.history.length > 50) appState.history.pop();

            input.value = "";
            save();
            updateUI();
        }

        function updateUI() {
            document.getElementById('balance-val').innerText = appState.balance.toLocaleString(undefined, {minimumFractionDigits:2});
            document.getElementById('streak-val').innerText = appState.streak;
            document.getElementById('goal-input').value = appState.goal;
            document.getElementById('goal-label').innerText = `${appState.balance.toLocaleString()} / ${appState.goal.toLocaleString()} ฿`;

            const p = Math.min(100, Math.round((appState.balance / appState.goal) * 100));
            document.getElementById('goal-percent-val').innerText = `${p}%`;
            document.getElementById('progress-bar').style.width = `${p}%`;

            const box = document.getElementById('history-box');
            if (appState.history.length === 0) {
                box.innerHTML = `<p class="text-center py-10 text-slate-300 italic text-sm">ไม่มีประวัติรายการ</p>`;
            } else {
                box.innerHTML = appState.history.map(item => `
                    <div class="flex justify-between items-center p-4 bg-slate-50/50 rounded-2xl border border-slate-100">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 rounded-xl flex items-center justify-center ${item.val > 0 ? 'bg-blue-100 text-blue-600' : 'bg-red-100 text-red-500'}">
                                <i class="fa-solid ${item.val > 0 ? 'fa-arrow-trend-up' : 'fa-receipt'}"></i>
                            </div>
                            <div>
                                <p class="font-bold ${item.val > 0 ? 'text-slate-800' : 'text-red-500'} text-sm">
                                    ${item.val > 0 ? '+' : ''}${item.val.toLocaleString()} ฿
                                </p>
                                <p class="text-[9px] font-bold text-slate-400 uppercase tracking-tighter">${item.date} • ${item.time}</p>
                            </div>
                        </div>
                        <span class="text-[10px] font-black uppercase tracking-widest ${item.val > 0 ? 'text-blue-400' : 'text-slate-300'}">${item.val > 0 ? 'SAVED' : 'SPENT'}</span>
                    </div>
                `).join('');
            }
        }

        window.tab = (t) => {
            ['home', 'stats', 'settings'].forEach(s => {
                document.getElementById(`${s}-section`).classList.toggle('hidden-section', s !== t);
                document.getElementById(`btn-${s}`).classList.toggle('active', s === t);
            });
            if (t === 'stats') renderStats();
        };

        window.updateGoal = () => {
            appState.goal = parseFloat(document.getElementById('goal-input').value) || 5000;
            save();
            updateUI();
            alert("อัปเดตเป้าหมายใหม่เรียบร้อย!");
        };

        window.wipe = () => {
            if (confirm("ระวัง! ข้อมูลทั้งหมดและรหัสผ่านจะถูกลบถาวร ยืนยันหรือไม่?")) {
                localStorage.clear();
                location.reload();
            }
        };

        let chart = null;
        function renderStats() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            const labels = [], values = [];
            let total = 0, count = 0, max = 0;

            for (let i=6; i>=0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const k = d.toISOString().split('T')[0];
                const val = appState.dailyStats[k] || 0;
                labels.push(d.getDate() + '/' + (d.getMonth()+1));
                values.push(val);
                
                if (val > 0) {
                    total += val;
                    count++;
                    if (val > max) max = val;
                }
            }

            document.getElementById('max-save-val').innerText = max.toLocaleString() + ' ฿';
            document.getElementById('avg-save-val').innerText = (count ? Math.round(total/count) : 0).toLocaleString() + ' ฿';

            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        data: values,
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, grid: { color: '#f1f5f9' } }, x: { grid: { display: false } } }
                }
            });
        }

        window.onload = initApp;
    </script>
</body>
</html>
