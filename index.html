<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Savings Tracker v3.3.0 (Stable)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap');
        
        :root {
            --primary: #6366f1;
            --secondary: #4f46e5;
            --surface: #ffffff;
            --background: #f8fafc;
        }

        body {
            font-family: 'Kanit', sans-serif;
            background-color: var(--background);
            padding-bottom: 120px;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            color: #1e293b;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 28px;
            border: 1px solid rgba(255, 255, 255, 0.7);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.03);
        }

        .modern-nav {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 35px;
            box-shadow: 0 15px 35px -10px rgba(0, 0, 0, 0.1);
        }

        .nav-item { color: #94a3b8; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); position: relative; }
        .nav-item.active { color: var(--primary); }
        
        .nav-item.active::after {
            content: '';
            position: absolute;
            bottom: -8px;
            width: 5px;
            height: 5px;
            background: var(--primary);
            border-radius: 50%;
        }

        #pin-overlay {
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at center, #ffffff 0%, #f1f5f9 100%);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .pin-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 2px solid #e2e8f0;
            transition: 0.3s;
        }

        .pin-dot.filled {
            background: var(--primary);
            border-color: var(--primary);
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.4);
            transform: scale(1.2);
        }

        .keypad-btn {
            width: 75px;
            height: 75px;
            border-radius: 50%;
            background: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.6rem;
            font-weight: 500;
            color: #334155;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            transition: 0.2s;
        }

        .keypad-btn:active:not(:disabled) { background: #f1f5f9; transform: scale(0.9); }
        .keypad-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        
        .hidden-section { display: none; }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-8px); }
            40%, 80% { transform: translateX(8px); }
        }
        .shake { animation: shake 0.4s; }

        .btn-main {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            transition: all 0.3s;
        }
        .btn-main:hover { opacity: 0.9; transform: translateY(-1px); }
        
        #history-box::-webkit-scrollbar { width: 4px; }
        #history-box::-webkit-scrollbar-track { background: transparent; }
        #history-box::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }

        #toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            z-index: 3000;
            transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #toast.show { transform: translateX(-50%) translateY(0); }

        .category-pill {
            cursor: pointer;
            transition: 0.2s;
            border: 1px solid #f1f5f9;
        }
        .category-pill.selected {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: scale(1.05);
        }
    </style>
</head>
<body>

    <!-- แจ้งเตือน Toast -->
    <div id="toast" class="bg-slate-900 text-white px-6 py-3 rounded-full shadow-2xl flex items-center space-x-3 text-sm font-bold">
        <i id="toast-icon" class="fa-solid fa-check-circle text-emerald-400"></i>
        <span id="toast-msg">บันทึกเรียบร้อย</span>
    </div>

    <!-- หน้าจอรหัสผ่าน (PIN) -->
    <div id="pin-overlay">
        <div class="text-center mb-10">
            <div id="pin-icon-box" class="w-24 h-24 bg-white shadow-xl text-indigo-500 rounded-[2.5rem] flex items-center justify-center mx-auto mb-6 text-4xl">
                <i class="fa-solid fa-shield-halved"></i>
            </div>
            <h2 id="pin-label" class="text-2xl font-black text-slate-800 tracking-tight">Wallet Secure</h2>
            <p id="pin-sub-label" class="text-slate-400 text-sm mt-1">ยืนยันรหัสผ่านเพื่อเข้าใช้งาน</p>
        </div>

        <div id="dots-container" class="flex space-x-6 mb-12">
            <div class="pin-dot" id="dot-0"></div>
            <div class="pin-dot" id="dot-1"></div>
            <div class="pin-dot" id="dot-2"></div>
            <div class="pin-dot" id="dot-3"></div>
        </div>

        <div class="grid grid-cols-3 gap-6" id="keypad">
            <button class="keypad-btn" onclick="tapKey('1')">1</button>
            <button class="keypad-btn" onclick="tapKey('2')">2</button>
            <button class="keypad-btn" onclick="tapKey('3')">3</button>
            <button class="keypad-btn" onclick="tapKey('4')">4</button>
            <button class="keypad-btn" onclick="tapKey('5')">5</button>
            <button class="keypad-btn" onclick="tapKey('6')">6</button>
            <button class="keypad-btn" onclick="tapKey('7')">7</button>
            <button class="keypad-btn" onclick="tapKey('8')">8</button>
            <button class="keypad-btn" onclick="tapKey('9')">9</button>
            <div class="flex items-center justify-center"><i class="fa-solid fa-face-smile text-slate-200"></i></div>
            <button class="keypad-btn" onclick="tapKey('0')">0</button>
            <button class="keypad-btn text-slate-300" onclick="tapKey('del')"><i class="fa-solid fa-delete-left"></i></button>
        </div>
    </div>

    <!-- อินเตอร์เฟซหลัก -->
    <div id="main-ui" style="display:none; opacity:0; transition: 0.7s cubic-bezier(0.4, 0, 0.2, 1);">
        <div class="max-w-md mx-auto p-6">
            
            <header class="flex justify-between items-center mb-8">
                <div>
                    <h1 class="text-3xl font-black text-slate-900">Wallet<span class="text-indigo-600">.</span></h1>
                    <span id="date-display" class="text-[11px] font-bold text-slate-400 uppercase tracking-widest">...</span>
                </div>
                <div class="bg-white p-2.5 px-5 rounded-[1.5rem] shadow-sm flex items-center space-x-2 border border-slate-50">
                    <i class="fa-solid fa-fire text-orange-500"></i>
                    <span id="streak-val" class="text-lg font-black text-slate-700">0</span>
                </div>
            </header>

            <main id="home-section" class="space-y-6">
                <!-- การ์ดยอดเงิน -->
                <div class="glass-card p-8 bg-indigo-600 text-white relative overflow-hidden shadow-2xl shadow-indigo-100">
                    <div class="absolute -right-6 -bottom-6 w-32 h-32 bg-white/10 rounded-full blur-3xl"></div>
                    <div class="absolute -left-6 -top-6 w-24 h-24 bg-indigo-400/20 rounded-full blur-2xl"></div>
                    
                    <p class="text-indigo-100 text-[10px] font-bold uppercase tracking-[0.2em] mb-2 opacity-80">ยอดเงินคงเหลือปัจจุบัน</p>
                    <div class="flex items-baseline space-x-2">
                        <span class="text-indigo-200 text-2xl font-bold">฿</span>
                        <h2 id="balance-val" class="text-5xl font-black tracking-tight">0.00</h2>
                    </div>
                </div>

                <!-- การ์ดเป้าหมาย -->
                <div class="glass-card p-6">
                    <div class="flex justify-between items-end mb-4">
                        <div>
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">เป้าหมายเดือนนี้</p>
                            <h3 id="goal-percent-val" class="text-2xl font-black text-indigo-600">0%</h3>
                        </div>
                        <p id="goal-label" class="text-xs font-bold text-slate-500">0 / 0 ฿</p>
                    </div>
                    <div class="w-full h-2.5 bg-slate-100 rounded-full overflow-hidden">
                        <div id="progress-bar" class="h-full bg-indigo-500 w-0 transition-all duration-1000"></div>
                    </div>
                </div>

                <!-- ส่วนป้อนข้อมูล -->
                <div class="glass-card p-6 space-y-4">
                    <div class="flex justify-between items-center mb-1">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">เลือกหมวดหมู่</p>
                    </div>
                    <div id="category-list" class="flex space-x-2 overflow-x-auto pb-2 scrollbar-hide">
                        <!-- รายการหมวดหมู่ -->
                    </div>

                    <div class="relative">
                        <input type="number" id="main-input" placeholder="0.00" class="w-full p-5 bg-slate-50 rounded-2xl text-3xl font-black text-slate-800 outline-none border-2 border-transparent focus:border-indigo-100 transition-all" inputmode="decimal">
                        <span class="absolute right-5 top-1/2 -translate-y-1/2 text-slate-300 font-bold">THB</span>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="record('save')" class="btn-main py-5 text-white rounded-2xl font-bold active:scale-95 shadow-lg shadow-indigo-100">
                            + ออมเงิน
                        </button>
                        <button onclick="record('spend')" class="bg-white border border-slate-200 py-5 text-slate-600 rounded-2xl font-bold active:scale-95">
                            - รายจ่าย
                        </button>
                    </div>
                </div>

                <!-- รายการล่าสุด -->
                <div class="glass-card p-6">
                    <div class="flex justify-between items-center mb-5">
                        <h4 class="font-bold text-slate-800 flex items-center space-x-2">
                            <i class="fa-solid fa-clock-rotate-left text-indigo-500"></i>
                            <span>รายการล่าสุด</span>
                        </h4>
                        <span class="text-[9px] bg-slate-100 px-2 py-1 rounded-md text-slate-500 font-bold uppercase tracking-wider">7 วันล่าสุด</span>
                    </div>
                    <div id="history-box" class="space-y-3 max-h-[350px] overflow-y-auto pr-1">
                        <!-- รายการประวัติจะแสดงที่นี่ -->
                    </div>
                </div>
            </main>

            <!-- ส่วนสถิติ -->
            <section id="stats-section" class="hidden-section space-y-6">
                <div class="glass-card p-6">
                    <h3 class="font-bold text-slate-800 mb-6 flex items-center space-x-2">
                        <i class="fa-solid fa-chart-pie text-indigo-500"></i>
                        <span>สรุปสัปดาห์นี้</span>
                    </h3>
                    <div class="h-[250px]"><canvas id="mainChart"></canvas></div>
                </div>
                <div class="glass-card p-6 grid grid-cols-2 divide-x divide-slate-100">
                    <div class="text-center">
                        <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">สูงสุดต่อวัน</p>
                        <p id="max-save-val" class="text-xl font-black text-indigo-600">0 ฿</p>
                    </div>
                    <div class="text-center">
                        <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">เฉลี่ยออม</p>
                        <p id="avg-save-val" class="text-xl font-black text-slate-800">0 ฿</p>
                    </div>
                </div>
            </section>

            <!-- ส่วนตั้งค่า -->
            <section id="settings-section" class="hidden-section space-y-6">
                <div class="glass-card p-6">
                    <h3 class="font-bold text-slate-800 mb-4">ตั้งเป้าหมาย</h3>
                    <div class="flex space-x-2">
                        <input type="number" id="goal-input" class="flex-1 p-4 bg-slate-50 rounded-xl font-bold outline-none border border-slate-100 focus:border-indigo-300">
                        <button onclick="updateGoal()" class="px-6 bg-indigo-600 text-white rounded-xl font-bold">บันทึก</button>
                    </div>
                </div>
                <div class="glass-card p-6 bg-white border border-slate-100">
                    <div class="flex items-center space-x-4 mb-4">
                        <div class="w-12 h-12 bg-indigo-50 text-indigo-600 rounded-xl flex items-center justify-center text-xl">
                            <i class="fa-solid fa-box-archive"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-slate-800">เวอร์ชัน 3.3.0</h4>
                            <p class="text-xs text-slate-400 tracking-tight">แสดงรายการล่าสุดไว้ด้านบนสุด</p>
                        </div>
                    </div>
                    <p class="text-xs text-slate-500 leading-relaxed italic">*ระบบจะดึงข้อมูลเดิมจากเวอร์ชันก่อนหน้ามาโดยอัตโนมัติ ข้อมูลของคุณจะไม่สูญหายเมื่อเปิดแอปใหม่</p>
                </div>
                <button onclick="wipe()" class="w-full py-4 text-red-400 font-bold text-sm bg-red-50 rounded-2xl">รีเซ็ตข้อมูลทั้งหมด (Reset)</button>
            </section>

            <!-- เมนูการนำทาง -->
            <div class="fixed bottom-8 left-6 right-6 z-[1000]">
                <nav class="modern-nav h-20 flex justify-around items-center px-4">
                    <button onclick="tab('home')" id="btn-home" class="nav-item active flex flex-col items-center flex-1">
                        <i class="fa-solid fa-house-chimney text-xl"></i>
                        <span class="text-[9px] font-black uppercase mt-1">หน้าหลัก</span>
                    </button>
                    <button onclick="tab('stats')" id="btn-stats" class="nav-item flex flex-col items-center flex-1">
                        <i class="fa-solid fa-chart-column text-xl"></i>
                        <span class="text-[9px] font-black uppercase mt-1">สถิติ</span>
                    </button>
                    <button onclick="tab('settings')" id="btn-settings" class="nav-item flex flex-col items-center flex-1">
                        <i class="fa-solid fa-gear text-xl"></i>
                        <span class="text-[9px] font-black uppercase mt-1">ตั้งค่า</span>
                    </button>
                </nav>
            </div>

        </div>
    </div>

    <script>
        const VERSION = "3.3.0";
        // ใช้ KEY เดิมเพื่อให้ข้อมูลไม่หาย
        const STORAGE_KEY = "wallet_v3_core_data"; 
        const PIN_KEY = "wallet_v3_pin_secure";
        const LOCK_UNTIL_KEY = "wallet_v3_lockout";
        const WRONG_KEY = "wallet_v3_wrong_count";

        const CATEGORIES = [
            { id: 'general', label: 'ทั่วไป', icon: 'fa-tags' },
            { id: 'food', label: 'อาหาร', icon: 'fa-utensils' },
            { id: 'travel', label: 'เดินทาง', icon: 'fa-bus' },
            { id: 'shopping', label: 'ช้อปปิ้ง', icon: 'fa-bag-shopping' },
            { id: 'home', label: 'ของใช้', icon: 'fa-house-laptop' }
        ];

        let state = {
            v: VERSION,
            balance: 0,
            goal: 5000,
            streak: 0,
            lastEntryDate: null,
            history: [],
            dailyStats: {}
        };

        let selectedCat = 'general';
        let pinInput = "";
        let timer = null;

        function init() {
            // ดึงข้อมูลเก่ามาใช้
            const rawData = localStorage.getItem(STORAGE_KEY);
            
            if (rawData) {
                try {
                    const parsed = JSON.parse(rawData);
                    // ผสานข้อมูลเดิมเข้ากับ Version 3.3.0
                    state = {
                        ...state,
                        ...parsed,
                        v: VERSION 
                    };
                    
                    if (state.balance === null || state.balance === undefined) state.balance = 0;

                    cleanOldHistory();
                    save(); 
                } catch(e) { console.error("Load Error:", e); }
            }

            const now = new Date();
            document.getElementById('date-display').innerText = new Intl.DateTimeFormat('th-TH', { weekday:'long', day:'numeric', month:'long' }).format(now);
            
            renderCategories();
            checkLock();
            updateUI();
        }

        function renderCategories() {
            const list = document.getElementById('category-list');
            list.innerHTML = CATEGORIES.map(c => `
                <div onclick="selectCat('${c.id}')" id="cat-${c.id}" class="category-pill flex-shrink-0 px-4 py-2 rounded-xl text-xs font-bold bg-white flex items-center space-x-2 ${c.id === selectedCat ? 'selected' : 'text-slate-400'}">
                    <i class="fa-solid ${c.icon}"></i>
                    <span>${c.label}</span>
                </div>
            `).join('');
        }

        function selectCat(id) {
            selectedCat = id;
            renderCategories();
        }

        function showToast(msg, isError = false) {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toast-icon');
            document.getElementById('toast-msg').innerText = msg;
            icon.className = isError ? "fa-solid fa-circle-exclamation text-rose-400" : "fa-solid fa-check-circle text-emerald-400";
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        }

        function cleanOldHistory() {
            const ONE_WEEK = 7 * 24 * 60 * 60 * 1000;
            const now = Date.now();
            if (state.history && state.history.length > 0) {
                state.history = state.history.filter(item => (now - item.id) < ONE_WEEK);
                // เรียงลำดับประวัติเก่าใหม่ล่าสุดไว้บนสุด (เผื่อกรณีข้อมูลเก่าเรียงผิด)
                state.history.sort((a, b) => b.id - a.id);
            }
        }

        function tapKey(k) {
            if (k === 'del') {
                pinInput = pinInput.slice(0, -1);
            } else if (pinInput.length < 4) {
                pinInput += k;
            }
            updateDots();
            if (pinInput.length === 4) setTimeout(checkPin, 150);
        }

        function updateDots() {
            for (let i=0; i<4; i++) {
                document.getElementById(`dot-${i}`).classList.toggle('filled', i < pinInput.length);
            }
        }

        function checkPin() {
            const saved = localStorage.getItem(PIN_KEY);
            if (!saved) {
                localStorage.setItem(PIN_KEY, pinInput);
                unlock();
            } else if (pinInput === saved) {
                localStorage.setItem(WRONG_KEY, "0");
                unlock();
            } else {
                let w = parseInt(localStorage.getItem(WRONG_KEY) || "0") + 1;
                localStorage.setItem(WRONG_KEY, w.toString());
                if (w >= 3) {
                    const until = Date.now() + 60000;
                    localStorage.setItem(LOCK_UNTIL_KEY, until.toString());
                    checkLock();
                } else { failPin("รหัสไม่ถูกต้อง!"); }
            }
        }

        function failPin(m) {
            pinInput = "";
            updateDots();
            const label = document.getElementById('pin-label');
            label.innerText = m;
            label.classList.add('text-red-500');
            document.getElementById('dots-container').classList.add('shake');
            setTimeout(() => {
                label.classList.remove('text-red-500');
                document.getElementById('dots-container').classList.remove('shake');
                label.innerText = "Wallet Secure";
            }, 1000);
        }

        function checkLock() {
            const lock = parseInt(localStorage.getItem(LOCK_UNTIL_KEY) || "0");
            if (Date.now() < lock) {
                pinInput = "";
                updateDots();
                document.querySelectorAll('.keypad-btn').forEach(b => b.disabled = true);
                if (timer) clearInterval(timer);
                timer = setInterval(() => {
                    const sec = Math.ceil((lock - Date.now()) / 1000);
                    if (sec <= 0) {
                        clearInterval(timer);
                        document.querySelectorAll('.keypad-btn').forEach(b => b.disabled = false);
                        localStorage.setItem(WRONG_KEY, "0");
                        localStorage.removeItem(LOCK_UNTIL_KEY);
                        document.getElementById('pin-label').innerText = "Wallet Secure";
                    } else {
                        document.getElementById('pin-label').innerText = "ล็อคชั่วคราว";
                        document.getElementById('pin-sub-label').innerText = `ลองใหม่ใน ${sec} วินาที`;
                    }
                }, 1000);
            }
        }

        function unlock() {
            document.getElementById('pin-overlay').style.display = 'none';
            const ui = document.getElementById('main-ui');
            ui.style.display = 'block';
            setTimeout(() => ui.style.opacity = "1", 50);
        }

        function save() { 
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); 
        }

        function record(type) {
            const input = document.getElementById('main-input');
            let val = parseFloat(input.value);
            if (!val || val <= 0) {
                showToast("กรุณาระบุจำนวนเงิน", true);
                return;
            }

            if (type === 'spend') val = -val;
            state.balance += val;

            const today = new Date().toISOString().split('T')[0];
            if (val > 0) {
                state.dailyStats[today] = (state.dailyStats[today] || 0) + val;
                if (state.lastEntryDate !== today) {
                    state.streak++;
                    state.lastEntryDate = today;
                }
            }

            const cat = CATEGORIES.find(c => c.id === selectedCat);

            // บันทึกรายการล่าสุดไว้ตำแหน่งแรกสุด (index 0)
            state.history.unshift({
                id: Date.now(),
                val: val,
                cat: cat.label,
                icon: cat.icon,
                time: new Date().toLocaleTimeString('th-TH', { hour:'2-digit', minute:'2-digit' }),
                date: new Date().toLocaleDateString('th-TH', { day:'numeric', month:'short' })
            });

            input.value = "";
            save(); 
            updateUI();
            showToast(val > 0 ? "ออมเงินสำเร็จ!" : "บันทึกรายจ่ายแล้ว");
        }

        function updateUI() {
            document.getElementById('balance-val').innerText = state.balance.toLocaleString(undefined, {minimumFractionDigits:2});
            document.getElementById('streak-val').innerText = state.streak;
            document.getElementById('goal-input').value = state.goal;
            document.getElementById('goal-label').innerText = `${state.balance.toLocaleString()} / ${state.goal.toLocaleString()} ฿`;

            const p = state.goal > 0 ? Math.min(100, Math.round((state.balance / state.goal) * 100)) : 0;
            document.getElementById('goal-percent-val').innerText = `${p}%`;
            document.getElementById('progress-bar').style.width = `${p}%`;

            const box = document.getElementById('history-box');
            if (!state.history || state.history.length === 0) {
                box.innerHTML = `<div class="flex flex-col items-center justify-center py-12 opacity-40">
                    <i class="fa-solid fa-receipt text-4xl mb-3"></i>
                    <p class="text-sm italic">ไม่มีรายการในสัปดาห์นี้</p>
                </div>`;
            } else {
                box.innerHTML = state.history.map(item => `
                    <div class="flex justify-between items-center p-4 bg-white rounded-2xl border border-slate-50 shadow-sm hover:shadow-md transition-shadow">
                        <div class="flex items-center space-x-4">
                            <div class="w-11 h-11 rounded-full flex items-center justify-center text-sm shadow-inner ${item.val > 0 ? 'bg-emerald-50 text-emerald-600' : 'bg-rose-50 text-rose-500'}">
                                <i class="fa-solid ${item.icon || (item.val > 0 ? 'fa-arrow-down' : 'fa-arrow-up')}"></i>
                            </div>
                            <div>
                                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-0.5">${item.date} • ${item.time}</p>
                                <p class="font-bold text-slate-800 text-base leading-none">
                                    ${item.cat || (item.val > 0 ? 'ออมเงิน' : 'ใช้จ่าย')}
                                </p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-black text-lg ${item.val > 0 ? 'text-emerald-500' : 'text-rose-500'}">
                                ${item.val > 0 ? '+' : ''}${item.val.toLocaleString()} ฿
                            </p>
                        </div>
                    </div>
                `).join('');
            }
        }

        window.tab = (t) => {
            ['home', 'stats', 'settings'].forEach(s => {
                document.getElementById(`${s}-section`).classList.toggle('hidden-section', s !== t);
                document.getElementById(`btn-${s}`).classList.toggle('active', s === t);
            });
            if (t === 'stats') renderChart();
        };

        window.updateGoal = () => {
            state.goal = parseFloat(document.getElementById('goal-input').value) || 5000;
            save(); updateUI();
            showToast("อัปเดตเป้าหมายแล้ว");
        };

        window.wipe = () => {
            if (confirm("ระวัง! ข้อมูลทั้งหมดจะหายไปถาวร ยืนยันหรือไม่?")) {
                localStorage.clear();
                location.reload();
            }
        };

        let myChart = null;
        function renderChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            const labels = [], vals = [];
            let total = 0, count = 0, max = 0;
            for (let i=6; i>=0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i);
                const k = d.toISOString().split('T')[0];
                const v = state.dailyStats[k] || 0;
                labels.push(d.getDate() + '/' + (d.getMonth()+1));
                vals.push(v);
                if (v > 0) { total += v; count++; if (v > max) max = v; }
            }
            document.getElementById('max-save-val').innerText = max.toLocaleString() + ' ฿';
            document.getElementById('avg-save-val').innerText = (count ? Math.round(total/count) : 0).toLocaleString() + ' ฿';
            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{ data: vals, backgroundColor: '#6366f1', borderRadius: 10, hoverBackgroundColor: '#4f46e5' }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { 
                        y: { beginAtZero: true, grid: { color: '#f8fafc' }, ticks: { font: { size: 10 } } },
                        x: { grid: { display: false }, ticks: { font: { size: 10 } } }
                    }
                }
            });
        }

        window.onload = init;
    </script>
</body>
</html>
