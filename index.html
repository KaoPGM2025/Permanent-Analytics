<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Savings Tracker (Data Restored)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap');
        
        body {
            font-family: 'Kanit', sans-serif;
            background-color: #f8fafc;
            padding-bottom: 120px;
            user-select: none;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border-radius: 32px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.04);
        }

        .nav-item { color: #94a3b8; transition: all 0.3s ease; }
        .nav-item.active { color: #3b82f6; transform: translateY(-4px); }

        #pin-overlay {
            position: fixed;
            inset: 0;
            background: #ffffff;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .pin-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 2px solid #cbd5e1;
            transition: all 0.2s;
        }

        .pin-dot.filled {
            background: #3b82f6;
            border-color: #3b82f6;
            transform: scale(1.2);
        }

        .keypad-btn {
            width: 75px;
            height: 75px;
            border-radius: 50%;
            background: #f1f5f9;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .keypad-btn:active:not(:disabled) { background: #e2e8f0; transform: scale(0.9); }
        .keypad-btn:disabled { opacity: 0.2; }
        
        .hidden-section { display: none; }
        .shake { animation: shake 0.4s; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
    </style>
</head>
<body>

    <!-- PIN Screen -->
    <div id="pin-overlay">
        <div class="text-center mb-8">
            <div id="pin-icon-box" class="w-20 h-20 bg-blue-50 text-blue-600 rounded-3xl flex items-center justify-center mx-auto mb-4 text-3xl">
                <i id="pin-icon" class="fa-solid fa-lock"></i>
            </div>
            <h2 id="pin-label" class="text-xl font-bold text-slate-800">กรุณากรอกรหัส PIN</h2>
            <p id="pin-sub-label" class="text-slate-400 text-sm mt-1">ข้อมูลถูกเข้ารหัสเพื่อความปลอดภัย</p>
        </div>

        <div id="dots-container" class="flex space-x-5 mb-10">
            <div class="pin-dot" id="dot-0"></div>
            <div class="pin-dot" id="dot-1"></div>
            <div class="pin-dot" id="dot-2"></div>
            <div class="pin-dot" id="dot-3"></div>
        </div>

        <div class="grid grid-cols-3 gap-5" id="keypad">
            <button class="keypad-btn" onclick="pressKey('1')">1</button>
            <button class="keypad-btn" onclick="pressKey('2')">2</button>
            <button class="keypad-btn" onclick="pressKey('3')">3</button>
            <button class="keypad-btn" onclick="pressKey('4')">4</button>
            <button class="keypad-btn" onclick="pressKey('5')">5</button>
            <button class="keypad-btn" onclick="pressKey('6')">6</button>
            <button class="keypad-btn" onclick="pressKey('7')">7</button>
            <button class="keypad-btn" onclick="pressKey('8')">8</button>
            <button class="keypad-btn" onclick="pressKey('9')">9</button>
            <div></div>
            <button class="keypad-btn" onclick="pressKey('0')">0</button>
            <button class="keypad-btn text-slate-400" onclick="pressKey('del')"><i class="fa-solid fa-backspace"></i></button>
        </div>
    </div>

    <!-- Main Content -->
    <div id="main-content" style="display:none; opacity:0; transition: opacity 0.5s;">
        <div class="max-w-md mx-auto p-5">
            <header class="flex justify-between items-center mb-8 pt-4">
                <div>
                    <p id="current-date" class="text-xs font-bold text-slate-400 uppercase tracking-widest">...</p>
                    <h1 class="text-2xl font-black text-slate-900">กระปุกออมเงิน</h1>
                </div>
                <div class="bg-orange-500 px-4 py-2 rounded-2xl text-white flex items-center space-x-2">
                    <i class="fa-solid fa-fire animate-bounce"></i>
                    <span id="streak-count" class="text-lg font-bold">0</span>
                </div>
            </header>

            <!-- Home Section -->
            <section id="home-section">
                <div class="glass-card p-6 mb-6 bg-slate-900 text-white">
                    <p class="text-slate-400 text-xs font-bold uppercase tracking-widest mb-1">ยอดเงินสะสมทั้งหมด</p>
                    <div class="flex items-baseline space-x-2">
                        <h2 id="total-savings" class="text-4xl font-black">0.00</h2>
                        <span class="text-blue-400 text-lg">฿</span>
                    </div>
                </div>

                <div class="glass-card p-6 mb-6">
                    <div class="flex justify-between mb-2">
                        <span id="goal-percent" class="font-bold text-blue-600">0%</span>
                        <span id="target-display" class="text-xs text-slate-400">เป้าหมาย: 5,000 ฿</span>
                    </div>
                    <div class="w-full h-3 bg-slate-100 rounded-full overflow-hidden">
                        <div id="goal-progress" class="h-full bg-blue-600 w-0 transition-all duration-1000"></div>
                    </div>
                </div>

                <div class="glass-card p-6 mb-6">
                    <input type="number" id="save-amount" placeholder="0.00" class="w-full p-4 bg-slate-50 border-none rounded-2xl text-2xl font-bold mb-4 outline-none focus:ring-2 ring-blue-500">
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="addEntry('save')" class="py-4 bg-blue-600 text-white rounded-2xl font-bold shadow-lg active:scale-95 transition-transform">+ รายรับ/ออม</button>
                        <button onclick="addEntry('spend')" class="py-4 bg-white border border-slate-200 text-slate-600 rounded-2xl font-bold active:scale-95 transition-transform">- รายจ่าย</button>
                    </div>
                </div>

                <div class="glass-card p-6">
                    <h3 class="font-bold text-slate-800 mb-4">ประวัติการทำรายการ</h3>
                    <div id="history-list" class="space-y-3 max-h-[300px] overflow-y-auto">
                        <p class="text-center text-slate-400 py-4 italic text-sm">ยังไม่มีรายการ</p>
                    </div>
                </div>
            </section>

            <!-- Stats Section -->
            <section id="graph-section" class="hidden-section">
                <div class="glass-card p-6 mb-6">
                    <h3 class="font-bold text-slate-800 mb-6 text-center">สถิติ 7 วันล่าสุด</h3>
                    <div class="h-[250px]"><canvas id="statsChart"></canvas></div>
                </div>
            </section>

            <!-- Settings Section -->
            <section id="settings-section" class="hidden-section">
                <div class="glass-card p-6 mb-6">
                    <h3 class="font-bold text-slate-800 mb-4">ตั้งเป้าหมายรายเดือน</h3>
                    <input type="number" id="goal-input" class="w-full p-4 bg-slate-50 rounded-2xl font-bold mb-4">
                    <button onclick="saveGoal()" class="w-full py-4 bg-slate-900 text-white rounded-2xl font-bold">บันทึกเป้าหมาย</button>
                </div>
                <button onclick="resetData()" class="w-full py-4 text-red-500 font-bold opacity-50">ล้างข้อมูลทั้งหมด (Reset)</button>
            </section>

            <!-- Nav -->
            <nav class="fixed bottom-0 left-0 right-0 h-20 bg-white border-t flex justify-around items-center px-6">
                <button onclick="switchTab('home')" class="nav-item active flex flex-col items-center"><i class="fa-solid fa-house"></i><span class="text-[10px] font-bold mt-1">หน้าหลัก</span></button>
                <button onclick="switchTab('graph')" class="nav-item flex flex-col items-center"><i class="fa-solid fa-chart-line"></i><span class="text-[10px] font-bold mt-1">สถิติ</span></button>
                <button onclick="switchTab('settings')" class="nav-item flex flex-col items-center"><i class="fa-solid fa-gear"></i><span class="text-[10px] font-bold mt-1">ตั้งค่า</span></button>
            </nav>
        </div>
    </div>

    <script>
        // ชื่อ Key สำหรับบันทึกข้อมูลแบบคงที่
        const APP_DATA_KEY = 'my_savings_app_data_secure';
        const PIN_KEY = 'my_savings_app_pin';
        const LOCKOUT_KEY = 'my_savings_lockout_time';
        const ATTEMPTS_KEY = 'my_savings_wrong_attempts';

        let state = {
            balance: 0,
            goal: 5000,
            streak: 0,
            lastDate: null,
            history: [], // รายการประวัติไม่ลบอัตโนมัติ
            daily: {}
        };

        let currentPin = "";
        let lockoutTimer = null;

        function init() {
            // 1. ดึงข้อมูลจากหลายชื่อตัวแปรเผื่อข้อมูลหาย (Migration)
            const oldData1 = localStorage.getItem('savings_app_v25');
            const oldData2 = localStorage.getItem('savings_app_v25_pin');
            const currentData = localStorage.getItem(APP_DATA_KEY);
            
            let finalData = currentData || oldData2 || oldData1;
            
            if (finalData) {
                try { 
                    state = { ...state, ...JSON.parse(finalData) }; 
                    // บันทึกกลับด้วย Key ใหม่ที่ถาวร
                    saveData();
                } catch(e) { console.error("Data parse error"); }
            }

            // 2. เช็คการล็อค
            const lockoutUntil = localStorage.getItem(LOCKOUT_KEY);
            if (lockoutUntil && Date.now() < parseInt(lockoutUntil)) {
                startLockout(parseInt(lockoutUntil));
            }

            // 3. แสดงวันที่
            const opts = { weekday: 'long', day: 'numeric', month: 'long' };
            document.getElementById('current-date').innerText = new Intl.DateTimeFormat('th-TH', opts).format(new Date());

            updateUI();
        }

        function saveData() {
            localStorage.setItem(APP_DATA_KEY, JSON.stringify(state));
        }

        // --- PIN Logic ---
        function pressKey(val) {
            if (val === 'del') {
                currentPin = currentPin.slice(0, -1);
            } else if (currentPin.length < 4) {
                currentPin += val;
            }
            updateDots();
            if (currentPin.length === 4) setTimeout(checkPin, 200);
        }

        function updateDots() {
            for (let i = 0; i < 4; i++) {
                const dot = document.getElementById(`dot-${i}`);
                if (i < currentPin.length) dot.classList.add('filled');
                else dot.classList.remove('filled');
            }
        }

        function checkPin() {
            const savedPin = localStorage.getItem(PIN_KEY);
            if (!savedPin) {
                localStorage.setItem(PIN_KEY, currentPin);
                unlock();
            } else {
                if (currentPin === savedPin) {
                    localStorage.setItem(ATTEMPTS_KEY, "0");
                    unlock();
                } else {
                    let attempts = parseInt(localStorage.getItem(ATTEMPTS_KEY) || "0") + 1;
                    localStorage.setItem(ATTEMPTS_KEY, attempts.toString());
                    
                    if (attempts >= 2) {
                        const unlockAt = Date.now() + 60000;
                        localStorage.setItem(LOCKOUT_KEY, unlockAt.toString());
                        startLockout(unlockAt);
                    } else {
                        failPin("รหัสไม่ถูกต้อง ลองได้อีก 1 ครั้ง");
                    }
                }
            }
        }

        function failPin(msg) {
            currentPin = "";
            updateDots();
            const label = document.getElementById('pin-label');
            label.innerText = msg;
            label.classList.add('text-red-500');
            document.getElementById('dots-container').classList.add('shake');
            setTimeout(() => {
                label.classList.remove('text-red-500');
                document.getElementById('dots-container').classList.remove('shake');
                label.innerText = "กรุณากรอกรหัส PIN";
            }, 1000);
        }

        function startLockout(until) {
            currentPin = "";
            updateDots();
            const btns = document.querySelectorAll('.keypad-btn');
            btns.forEach(b => b.disabled = true);
            
            lockoutTimer = setInterval(() => {
                const left = Math.ceil((until - Date.now()) / 1000);
                if (left <= 0) {
                    clearInterval(lockoutTimer);
                    btns.forEach(b => b.disabled = false);
                    localStorage.setItem(ATTEMPTS_KEY, "0");
                    localStorage.removeItem(LOCKOUT_KEY);
                    document.getElementById('pin-label').innerText = "กรุณากรอกรหัส PIN";
                    document.getElementById('pin-sub-label').innerText = "ปลดล็อคแล้ว ลองใหม่อีกครั้ง";
                } else {
                    document.getElementById('pin-label').innerText = "ระบบถูกระงับ";
                    document.getElementById('pin-sub-label').innerText = `ลองใหม่ในอีก ${left} วินาที`;
                }
            }, 1000);
        }

        function unlock() {
            document.getElementById('pin-overlay').style.display = 'none';
            const main = document.getElementById('main-content');
            main.style.display = 'block';
            setTimeout(() => main.style.opacity = "1", 50);
        }

        // --- App Logic ---
        function addEntry(type) {
            const input = document.getElementById('save-amount');
            let amt = parseFloat(input.value);
            if (!amt || amt <= 0) return;
            
            if (type === 'spend') amt = -amt;
            
            state.balance += amt;
            const today = new Date().toISOString().split('T')[0];
            
            if (amt > 0) {
                state.daily[today] = (state.daily[today] || 0) + amt;
                if (state.lastDate !== today) {
                    state.streak++;
                    state.lastDate = today;
                }
            }
            
            state.history.unshift({
                id: Date.now(),
                amt: amt,
                date: new Date().toLocaleString('th-TH')
            });

            input.value = "";
            saveData();
            updateUI();
        }

        function updateUI() {
            document.getElementById('total-savings').innerText = state.balance.toLocaleString(undefined, {minimumFractionDigits: 2});
            document.getElementById('streak-count').innerText = state.streak;
            document.getElementById('target-display').innerText = `เป้าหมาย: ${state.goal.toLocaleString()} ฿`;
            document.getElementById('goal-input').value = state.goal;

            const p = Math.min(100, Math.round((state.balance / state.goal) * 100));
            document.getElementById('goal-percent').innerText = `${p}%`;
            document.getElementById('goal-progress').style.width = `${p}%`;

            const list = document.getElementById('history-list');
            if (state.history.length === 0) {
                list.innerHTML = '<p class="text-center text-slate-400 py-4 italic text-sm">ยังไม่มีรายการ</p>';
            } else {
                list.innerHTML = state.history.map(item => `
                    <div class="flex justify-between items-center p-4 bg-slate-50 rounded-2xl">
                        <div>
                            <p class="font-bold ${item.amt > 0 ? 'text-slate-800' : 'text-red-500'}">
                                ${item.amt > 0 ? '+' : ''}${item.amt.toLocaleString()} ฿
                            </p>
                            <p class="text-[10px] text-slate-400 uppercase">${item.date}</p>
                        </div>
                        <i class="fa-solid ${item.amt > 0 ? 'fa-circle-plus text-blue-500' : 'fa-circle-minus text-red-400'}"></i>
                    </div>
                `).join('');
            }
        }

        window.switchTab = (tab) => {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden-section'));
            document.getElementById(`${tab}-section`).classList.remove('hidden-section');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            event.currentTarget.classList.add('active');
            if (tab === 'graph') drawChart();
        };

        window.saveGoal = () => {
            state.goal = parseFloat(document.getElementById('goal-input').value) || 5000;
            saveData();
            updateUI();
            alert("บันทึกเป้าหมายแล้ว");
        };

        window.resetData = () => {
            if (confirm("ต้องการลบข้อมูลทั้งหมดรวมถึงรหัส PIN ใช่หรือไม่?")) {
                localStorage.clear();
                location.reload();
            }
        };

        let chart = null;
        function drawChart() {
            const ctx = document.getElementById('statsChart').getContext('2d');
            const labels = [], data = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const k = d.toISOString().split('T')[0];
                labels.push(d.getDate() + '/' + (d.getMonth()+1));
                data.push(state.daily[k] || 0);
            }
            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets: [{ label: 'เงินออม', data, backgroundColor: '#3b82f6', borderRadius: 8 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        window.onload = init;
    </script>
</body>
</html>
